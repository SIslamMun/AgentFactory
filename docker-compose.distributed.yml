# Distributed setup: 2 IOWarp bridges + 2 Memcached nodes on one machine.
#
# Usage:
#   docker-compose -f docker-compose.distributed.yml up -d
#   docker-compose -f docker-compose.distributed.yml ps
#   docker-compose -f docker-compose.distributed.yml down
#
# Ports:
#   IOWarp node 1:    tcp://127.0.0.1:5560
#   IOWarp node 2:    tcp://127.0.0.1:5561
#   Memcached node 1: 127.0.0.1:11211
#   Memcached node 2: 127.0.0.1:11212

services:
  iowarp-node1:
    build: ./docker/iowarp
    network_mode: host
    ipc: shareable
    shm_size: "4g"
    volumes:
      - ./data:/data
      - iowarp-storage-1:/var/lib/iowarp
    environment:
      - BRIDGE_PORT=5560
    healthcheck:
      test: ["CMD", "python3", "-c", "import zmq; c=zmq.Context(); s=c.socket(zmq.REQ); s.connect('tcp://127.0.0.1:5560'); s.send_json({'method':'ping'}); r=s.recv_json(); s.close(); c.term(); assert r.get('result')=='pong'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  iowarp-node2:
    build: ./docker/iowarp
    network_mode: host
    ipc: shareable
    shm_size: "4g"
    volumes:
      - ./data:/data
      - iowarp-storage-2:/var/lib/iowarp
    environment:
      - BRIDGE_PORT=5561
    healthcheck:
      test: ["CMD", "python3", "-c", "import zmq; c=zmq.Context(); s=c.socket(zmq.REQ); s.connect('tcp://127.0.0.1:5561'); s.send_json({'method':'ping'}); r=s.recv_json(); s.close(); c.term(); assert r.get('result')=='pong'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  memcached-node1:
    image: memcached:1.6-alpine
    network_mode: host
    command: memcached -m 256 -I 8m -p 11211
    healthcheck:
      test: ["CMD-SHELL", "echo stats | nc -w 1 127.0.0.1 11211 | grep -q pid"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  memcached-node2:
    image: memcached:1.6-alpine
    network_mode: host
    command: memcached -m 256 -I 8m -p 11212
    healthcheck:
      test: ["CMD-SHELL", "echo stats | nc -w 1 127.0.0.1 11212 | grep -q pid"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

volumes:
  iowarp-storage-1:
  iowarp-storage-2:
