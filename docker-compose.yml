services:
  iowarp:
    build: ./docker/iowarp
    network_mode: host
    ipc: shareable
    shm_size: "8g"
    volumes:
      - .:/workspace  # Mount workspace for file access in stub mode
      - ./data:/data
      - iowarp-storage:/var/lib/iowarp
    environment:
      - BRIDGE_PORT=5560
    working_dir: /workspace  # Set working directory to workspace
    healthcheck:
      test: ["CMD", "python3", "-c", "import zmq; c=zmq.Context(); s=c.socket(zmq.REQ); s.connect('tcp://127.0.0.1:5560'); s.send_json({'method':'ping'}); r=s.recv_json(); s.close(); c.term(); assert r.get('result')=='pong'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  memcached:
    image: memcached:1.6-alpine
    network_mode: host
    command: memcached -m 512 -I 8m -p 11211
    healthcheck:
      test: ["CMD-SHELL", "echo stats | nc -w 1 127.0.0.1 11211 | grep -q pid"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

volumes:
  iowarp-storage:
